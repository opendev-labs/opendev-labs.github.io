name: Generate OpenHub Profile
on:
  issues:
    types: [labeled]

jobs:
  generate:
    if: github.event.label.name == 'openhub-profile'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Profile HTML
        id: build
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          node -e '
          const fs = require("fs");
          const body = process.env.ISSUE_BODY;
          
          function getFieldValue(label) {
            const regex = new RegExp(`### ${label}\\s+([\\s\\S]*?)(?=\\n###|$)`);
            const match = body.match(regex);
            return match ? match[1].trim() : "";
          }

          const username = getFieldValue("Universal Handle");
          const fullName = getFieldValue("Full Identity Name");
          const headline = getFieldValue("Professional Headline");
          const bio = getFieldValue("Biography");
          const energyType = getFieldValue("Energy Type / Frequency");
          const avatarUrl = getFieldValue("Avatar URL");
          const bannerUrl = getFieldValue("Banner URL") || "https://images.unsplash.com/photo-1614850523296-d8c1af93d400";
          const instagram = getFieldValue("Instagram Handle").replace("@", "");
          const twitter = getFieldValue("X (Twitter) Handle").replace("@", "");
          const publicKey = getFieldValue("Sovereign Public Key (Optional)") || "PROVISIONED_BY_MESH";

          if (!username) {
            console.error("No username found");
            process.exit(1);
          }

          let template = fs.readFileSync("templates/profile.html", "utf8");
          const output = template
            .replace(/\{\{USERNAME\}\}/g, username)
            .replace(/\{\{FULL_NAME\}\}/g, fullName)
            .replace(/\{\{HEADLINE\}\}/g, headline)
            .replace(/\{\{BIO\}\}/g, bio)
            .replace(/\{\{ENERGY_TYPE\}\}/g, energyType)
            .replace(/\{\{AVATAR_URL\}\}/g, avatarUrl)
            .replace(/\{\{BANNER_URL\}\}/g, bannerUrl)
            .replace(/\{\{INSTAGRAM\}\}/g, instagram)
            .replace(/\{\{TWITTER\}\}/g, twitter)
            .replace(/\{\{PUBLIC_KEY\}\}/g, publicKey);

          const dir = `user/${username}`;
          if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
          fs.writeFileSync(`${dir}/index.html`, output);
          console.log(`::set-output name=username::${username}`);
          '

      - name: Commit and Push
        run: |
          git config --global user.name "OpenHub Bot"
          git config --global user.email "bot@opendev-labs.io"
          git add user/
          git commit -m "feat: materialize profile for ${{ github.event.issue.user.login }}"
          git push

      - name: Comment on Issue
        uses: actions/github-script@v7
        with:
          script: |
            const username = process.env.ISSUE_BODY.match(/### Universal Handle\s+([\s\S]*?)(?=\n###|$)/)[1].trim();
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Profile Materialized!**\n\nYour sovereign home is live at: https://opendev-labs.github.io/user/${username}\n\nProtocol synchronized. Closing node request.`
            });
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed"
            });
